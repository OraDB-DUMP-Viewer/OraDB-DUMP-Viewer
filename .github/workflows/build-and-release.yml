name: Build and Release

# ───────────────────────────────────────────
# トリガー: release ブランチへの push 時に実行
# ───────────────────────────────────────────
on:
  push:
    branches:
      - release

jobs:
  build:
    name: Build & Release
    runs-on: windows-latest

    permissions:
      contents: write  # GitHub Release の作成に必要

    steps:
      # ─────────────────────────────────────
      # 1. ソースコードをチェックアウト
      # ─────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ─────────────────────────────────────
      # 2. .NET SDK のセットアップ (.NET 10)
      # ─────────────────────────────────────
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      # ─────────────────────────────────────
      # 3. MSVC 環境セットアップ (C DLL ビルド用)
      # ─────────────────────────────────────
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ─────────────────────────────────────
      # 4. C ネイティブ DLL ビルド
      #    OraDB_DumpParser.dll を cl.exe で直接ビルド
      # ─────────────────────────────────────
      - name: Build native DLL (OraDB_DumpParser.dll)
        shell: cmd
        working-directory: Logics/DumpParser
        run: |
          set DEFS=/DWINDOWS /DWIN32 /DUTF8 /DODV_DLL_MODE /D_CRT_SECURE_NO_WARNINGS /DNDEBUG
          set CFLAGS=/O2 /W3 /LD /MT /nologo /utf-8 /std:c11
          set SRCS=odv_api.c odv_detect.c odv_expdp.c odv_exp.c odv_record.c odv_number.c odv_datetime.c odv_charset.c odv_xml.c odv_csv.c odv_sql.c
          cl %CFLAGS% %DEFS% /I "." /Fe"OraDB_DumpParser.dll" %SRCS% /link /DLL
          if %ERRORLEVEL% NEQ 0 exit /b 1
          del /q *.obj *.exp *.lib 2>nul
          echo DLL built successfully
          dir OraDB_DumpParser.dll

      # ─────────────────────────────────────
      # 5. バージョン番号を .vbproj から取得
      # ─────────────────────────────────────
      - name: Get version from .vbproj
        id: get_version
        shell: pwsh
        run: |
          [xml]$xml = Get-Content "OraDB DUMP Viewer.vbproj"
          $version = $xml.Project.PropertyGroup `
            | Where-Object { $_.Version } `
            | Select-Object -ExpandProperty Version -First 1
          if (-not $version) { $version = "1.0.0" }
          Write-Host "Version: $version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG=v$version" >> $env:GITHUB_OUTPUT

      # ─────────────────────────────────────
      # 6. CHANGELOG.md から該当バージョンの
      #    リリースノートを抽出
      # ─────────────────────────────────────
      - name: Extract release notes from CHANGELOG.md
        id: changelog
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"

          if (-not (Test-Path "CHANGELOG.md")) {
            Write-Host "CHANGELOG.md が見つかりません。空のリリースノートを使用します。"
            $notes = "No release notes."
          } else {
            $content = Get-Content "CHANGELOG.md" -Raw
            # ## [0.1.2] または ## 0.1.2 の形式に対応
            $escaped = [regex]::Escape($version)
            $pattern = "(?ms)^## \[?${escaped}\]?[^\n]*\n(.*?)(?=\n## |\Z)"
            $match = [regex]::Match($content, $pattern)
            if ($match.Success) {
              $notes = $match.Groups[1].Value.Trim()
              Write-Host "リリースノートを取得しました"
            } else {
              $notes = "No release notes for v${version}."
              Write-Host "該当バージョンのセクションが見つかりませんでした"
            }
          }

          # 複数行を GITHUB_OUTPUT に書き込む
          $delimiter = "EOF_CHANGELOG"
          "NOTES<<$delimiter" | Out-File -Append -Encoding utf8 $env:GITHUB_OUTPUT
          $notes | Out-File -Append -Encoding utf8 $env:GITHUB_OUTPUT
          $delimiter | Out-File -Append -Encoding utf8 $env:GITHUB_OUTPUT

      # ─────────────────────────────────────
      # 7. NuGet パッケージの復元
      # ─────────────────────────────────────
      - name: Restore dependencies
        run: dotnet restore "OraDB DUMP Viewer.vbproj"

      # ─────────────────────────────────────
      # 8a. ポータブル版ビルド (Self-contained)
      #     .NET ランタイム同梱 → 解凍してすぐ使える
      # ─────────────────────────────────────
      - name: Build portable (self-contained)
        run: |
          dotnet publish "OraDB DUMP Viewer.vbproj" `
            --configuration Release `
            --runtime win-x64 `
            --self-contained true `
            --output ./publish/portable

      # ─────────────────────────────────────
      # 8b. MSI 用ビルド (Framework-dependent)
      #     .NET ランタイムは別途インストール → 軽量
      # ─────────────────────────────────────
      - name: Build for MSI (framework-dependent)
        run: |
          dotnet publish "OraDB DUMP Viewer.vbproj" `
            --configuration Release `
            --runtime win-x64 `
            --self-contained false `
            --output ./publish/msi

      # ─────────────────────────────────────
      # 9. DLL が出力に含まれていることを検証
      # ─────────────────────────────────────
      - name: Verify native DLL in output
        shell: pwsh
        run: |
          foreach ($dir in @("./publish/portable", "./publish/msi")) {
            if (-not (Test-Path "$dir/OraDB_DumpParser.dll")) {
              Write-Error "OraDB_DumpParser.dll が $dir に含まれていません"
              exit 1
            }
          }
          Write-Host "OraDB_DumpParser.dll found in both outputs"

      # ─────────────────────────────────────
      # 10. ポータブル版を ZIP に圧縮
      # ─────────────────────────────────────
      - name: Zip portable
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          Compress-Archive `
            -Path "./publish/portable/*" `
            -DestinationPath "./publish/OraDBDumpViewer_v${version}_portable.zip"

      # ─────────────────────────────────────
      # 11. WiX Toolset v5.0.2 のインストール
      # ─────────────────────────────────────
      - name: Install WiX Toolset
        run: dotnet tool install --global wix --version 5.0.2

      # ─────────────────────────────────────
      # 12. WiX UI 拡張を追加
      # ─────────────────────────────────────
      - name: Add WiX UI extension
        run: wix extension add WixToolset.UI.wixext/5.0.2

      # ─────────────────────────────────────
      # 13. WiX ソースファイルの生成
      # ─────────────────────────────────────
      - name: Generate WiX source file
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $exeDir = "$env:GITHUB_WORKSPACE\publish\msi"

          $wxs = @"
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
               xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

            <Package Name="OraDB DUMP Viewer"
                     Version="${version}"
                     Manufacturer="YANAI Taketo"
                     UpgradeCode="cd3b541d-5df6-4737-9bcc-16a4329a8a54"
                     Codepage="65001"
                     Scope="perMachine"
                     Language="1041">

              <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
              <MediaTemplate EmbedCab="yes" />

              <!-- .NET 10.0 ランタイムの存在チェックと案内 -->
              <Property Id="DOTNET_INSTALLED">
                <RegistrySearch Id="CheckDotNet10Runtime" Root="HKLM" Key="SOFTWARE\dotnet\Setup\InstalledVersions\x64\sharedhost" Name="Version" Type="raw" />
              </Property>
              <Launch Condition="DOTNET_INSTALLED" Message=".NET 10.0 ランタイムが必要です。インストールしてから再度セットアップを実行してください。&#10;&#10;ダウンロード: https://dotnet.microsoft.com/ja-jp/download/dotnet/10.0" />

              <ui:WixUI Id="WixUI_InstallDir" />
              <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

              <Feature Id="ProductFeature" Title="OraDB DUMP Viewer" Level="1">
                <ComponentGroupRef Id="ProductComponents" />
                <ComponentRef Id="DesktopShortcut" />
                <ComponentRef Id="StartMenuShortcut" />
              </Feature>

              <!-- インストール先フォルダ -->
              <StandardDirectory Id="ProgramFiles64Folder">
                <Directory Id="INSTALLFOLDER" Name="OraDB DUMP Viewer" />
              </StandardDirectory>

              <!-- デスクトップ -->
              <StandardDirectory Id="DesktopFolder">
                <Component Id="DesktopShortcut" Guid="*">
                  <Shortcut Id="DesktopShortcutLink"
                            Name="OraDB DUMP Viewer"
                            Description="OraDB DUMP Viewer"
                            Target="[INSTALLFOLDER]OraDB DUMP Viewer.exe"
                            WorkingDirectory="INSTALLFOLDER" />
                  <RegistryValue Root="HKCU"
                                 Key="Software\YANAI Taketo\OraDB DUMP Viewer"
                                 Name="DesktopShortcut"
                                 Type="integer"
                                 Value="1"
                                 KeyPath="yes" />
                </Component>
              </StandardDirectory>

              <!-- スタートメニュー -->
              <StandardDirectory Id="ProgramMenuFolder">
                <Directory Id="AppStartMenuFolder" Name="OraDB DUMP Viewer">
                  <Component Id="StartMenuShortcut" Guid="*">
                    <Shortcut Id="StartMenuShortcutLink"
                              Name="OraDB DUMP Viewer"
                              Description="OraDB DUMP Viewer"
                              Target="[INSTALLFOLDER]OraDB DUMP Viewer.exe"
                              WorkingDirectory="INSTALLFOLDER" />
                    <RemoveFolder Id="RemoveStartMenuFolder"
                                  Directory="AppStartMenuFolder"
                                  On="uninstall" />
                    <RegistryValue Root="HKCU"
                                   Key="Software\YANAI Taketo\OraDB DUMP Viewer"
                                   Name="StartMenuShortcut"
                                   Type="integer"
                                   Value="1"
                                   KeyPath="yes" />
                  </Component>
                </Directory>
              </StandardDirectory>

              <!-- アプリ本体ファイル -->
              <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
                <Files Include="${exeDir}\**" />
              </ComponentGroup>

            </Package>
          </Wix>
          "@
          $wxs | Set-Content -Path installer.wxs -Encoding UTF8

      # ─────────────────────────────────────
      # 14. .msi インストーラーのビルド
      # ─────────────────────────────────────
      - name: Build MSI installer
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          wix build installer.wxs `
            -ext WixToolset.UI.wixext `
            -o "./publish/OraDBDumpViewer_v${version}_installer.msi"

      # ─────────────────────────────────────
      # 15. GitHub Release の作成 & アップロード
      #     body に CHANGELOG.md の内容を使用
      # ─────────────────────────────────────
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.TAG }}
          name: Release ${{ steps.get_version.outputs.TAG }}
          body: ${{ steps.changelog.outputs.NOTES }}
          draft: false
          prerelease: false
          files: |
            ./publish/OraDBDumpViewer_v${{ steps.get_version.outputs.VERSION }}_portable.zip
            ./publish/OraDBDumpViewer_v${{ steps.get_version.outputs.VERSION }}_installer.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}